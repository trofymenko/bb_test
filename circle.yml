machine:
  environment:
    SEXY_SETTINGS: driver=selenium, selenium_browser=chrome

dependencies:
  pre:
    # update chromedriver
    - wget https://chromedriver.storage.googleapis.com/2.42/chromedriver_linux64.zip
    - unzip chromedriver_linux64.zip
    - sudo mv chromedriver /usr/local/bin
    - rm chromedriver_linux64.zip
    # install latest Chrome
    - curl -L -o google-chrome.deb https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    - sudo dpkg -i google-chrome.deb
    - sudo sed -i 's|HERE/chrome\"|HERE/chrome\" --disable-setuid-sandbox|g' /opt/google/chrome/google-chrome
    - rm google-chrome.deb

test:
  override:
#    - bundle exec rake features:bvt || CUCUMBER_RERUN_FAILED=true bundle exec rake features:bvt
#    - bundle exec rake features:p1 || CUCUMBER_RERUN_FAILED=true bundle exec rake features:p1
#    - bundle exec rake features:p2 || CUCUMBER_RERUN_FAILED=true bundle exec rake features:p2

    - ? |
        case $CIRCLE_NODE_INDEX in
          0)
            bundle exec rake features:bvt || CUCUMBER_RERUN_FAILED=true bundle exec rake features:bvt
            bundle exec rake features:p1 || CUCUMBER_RERUN_FAILED=true bundle exec rake features:p1
            ;;
          1) bundle exec rake features:p2 || CUCUMBER_RERUN_FAILED=true bundle exec rake features:p2 ;;
        esac
      :
        parallel: true